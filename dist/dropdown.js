'use strict';

if (!NodeList.prototype.forEach) {
	NodeList.prototype.forEach = Array.prototype.forEach;
}

var debug = function debug() {}; // console.log.bind(console);
function closeRelated(subnav) {
	subnav.parentElement.querySelectorAll('.open').forEach(function (subnav) {
		subnav.classList.remove('open');
	});
}
function openNested(subnav) {
	var xPos = '95%';
	var yPos = '-0.2em';
	closeRelated(subnav);
	subnav.classList.add('open');
	var ul = subnav.querySelector('ul');
	var rect = subnav.getBoundingClientRect();
	var ulRect = ul.getBoundingClientRect();

	ul.style.top = '';
	ul.style.bottom = '';
	ul.style.left = '';
	ul.style.right = '';
	if (rect.right + ulRect.width > window.innerWidth) {
		ul.style.right = xPos;
	} else {
		ul.style.left = xPos;
	}
	if (rect.top + ulRect.height > window.innerHeight) {
		ul.style.bottom = yPos;
	} else {
		ul.style.top = yPos;
	}
}
function navClick(e) {
	debug(e.target);
	if (e.target.classList.contains('subnav')) {
		openNested(e.target);
		e.stopPropagation();
	}
}

var elts = document.querySelectorAll('[data-dropdown-trigger]');
elts.forEach(function (elt) {
	return elt.addEventListener('click', function (evt) {
		evt.stopPropagation();
		var id = elt.getAttribute('data-dropdown-trigger');
		var nav = document.getElementById(id);
		nav.querySelectorAll('.open,.active').forEach(function (elt) {
			elt.classList.remove('open', 'active');
		});
		nav.classList.add('opened');
		if (evt.clientX && evt.clientY) {
			nav.style.left = evt.clientX + 'px';
			nav.style.top = window.pageYOffset + evt.clientY + 'px';
		} else {
			var _rect = elt.getBoundingClientRect();
			debug(_rect);
			nav.style.top = _rect.right + 'px';
			nav.style.left = _rect.bottom + 'px';
		}

		var rect = nav.getBoundingClientRect();
		if (rect.right > window.innerWidth) {
			var pxs = nav.style.left.replace(/px$/, '');
			nav.style.left = pxs - rect.width + 'px';
		}
		if (rect.bottom > window.innerHeight) {
			var _pxs = nav.style.top.replace(/px$/, '');
			nav.style.top = _pxs - rect.height + 'px';
		}
		debug({ id: id, nav: nav });

		var timeout = void 0;
		function mouseEnter(e) {
			debug('mouseenter', e.target);

			e.target.classList.add('active');

			clearTimeout(timeout);
			if (e.target.classList.contains('subnav')) {
				timeout = setTimeout(openNested.bind(null, e.target), 500);
			} else {
				timeout = setTimeout(closeRelated.bind(null, e.target), 500);
			}
		}
		function mouseLeave(e) {
			clearTimeout(timeout);
			e.target.classList.remove('active');
			debug('mouseleave', e.target);
		}
		function keyboardNavigation(e) {
			var open = nav.querySelectorAll('.open > ul');
			if (open.length > 0) {
				open = open[open.length - 1];
			} else {
				open = nav;
			}
			var active = open.querySelector('li.active');
			debug(open);
			var next = void 0;
			switch (e.keyCode) {
				case 38:
					// up arrow
					e.stopPropagation();
					e.preventDefault();
					if (active) {
						next = active.previousElementSibling;
						active.classList.remove('active');
					}
					if (!next) {
						next = open.children[open.children.length - 1];
					}
					next.classList.add('active');
					break;
				case 40:
					// down arrow
					e.stopPropagation();
					e.preventDefault();
					if (active) {
						next = active.nextElementSibling;
						active.classList.remove('active');
					}
					if (!next) {
						next = open.children[0];
					}
					next.classList.add('active');
					break;
				case 37:
					// left arrow
					e.stopPropagation();
					e.preventDefault();
					if (active) {
						active.classList.remove('active');
						active.parentElement.parentElement.classList.remove('open');
						active.parentElement.parentElement.classList.add('active');
					} else {
						if (open && open !== nav) {
							closeRelated(open.parentElement);
						}
					}
					break;
				case 39:
					// right arrow
					e.stopPropagation();
					e.preventDefault();
					if (active) {
						openNested(active);
						active.querySelector('li').classList.add('active');
					}
					break;
				case 13:
					// enter
					e.stopPropagation();
					e.preventDefault();
					if (active) {
						active.click();
					}
					break;
				case 27:
					dismiss();
					break;
			}
		}

		function dismiss() {
			nav.classList.remove('opened');
			document.removeEventListener('keypress', keyboardNavigation);
			document.removeEventListener('click', dismiss);

			nav.removeEventListener('click', navClick);

			nav.querySelectorAll('li').forEach(function (subnav) {
				subnav.classList.remove('open', 'active');
				subnav.removeEventListener('mouseenter', mouseEnter);
				subnav.removeEventListener('mouseleave', mouseLeave);
			});
		}

		nav.querySelectorAll('li').forEach(function (subnav) {
			subnav.addEventListener('mouseenter', mouseEnter);
			subnav.addEventListener('mouseleave', mouseLeave);
		});
		nav.addEventListener('click', navClick);
		document.addEventListener('keydown', keyboardNavigation);
		document.addEventListener('click', dismiss);
	});
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9kcm9wZG93bi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLElBQUcsQ0FBQyxTQUFTLFNBQVQsQ0FBbUIsT0FBdkIsRUFBZ0M7QUFDL0IsVUFBUyxTQUFULENBQW1CLE9BQW5CLEdBQTZCLE1BQU0sU0FBTixDQUFnQixPQUE3QztBQUNBOztBQUVELElBQU0sUUFBUSxTQUFSLEtBQVEsR0FBTSxDQUFFLENBQXRCLEMsQ0FBdUI7QUFDdkIsU0FBUyxZQUFULENBQXNCLE1BQXRCLEVBQThCO0FBQzdCLFFBQU8sYUFBUCxDQUFxQixnQkFBckIsQ0FBc0MsT0FBdEMsRUFBK0MsT0FBL0MsQ0FBdUQsVUFBUyxNQUFULEVBQWlCO0FBQ3ZFLFNBQU8sU0FBUCxDQUFpQixNQUFqQixDQUF3QixNQUF4QjtBQUNBLEVBRkQ7QUFHQTtBQUNELFNBQVMsVUFBVCxDQUFvQixNQUFwQixFQUE0QjtBQUMzQixLQUFNLE9BQU8sS0FBYjtBQUNBLEtBQU0sT0FBTyxRQUFiO0FBQ0EsY0FBYSxNQUFiO0FBQ0EsUUFBTyxTQUFQLENBQWlCLEdBQWpCLENBQXFCLE1BQXJCO0FBQ0EsS0FBTSxLQUFLLE9BQU8sYUFBUCxDQUFxQixJQUFyQixDQUFYO0FBQ0EsS0FBTSxPQUFPLE9BQU8scUJBQVAsRUFBYjtBQUNBLEtBQU0sU0FBUyxHQUFHLHFCQUFILEVBQWY7O0FBRUcsSUFBRyxLQUFILENBQVMsR0FBVCxHQUFlLEVBQWY7QUFDQSxJQUFHLEtBQUgsQ0FBUyxNQUFULEdBQWtCLEVBQWxCO0FBQ0EsSUFBRyxLQUFILENBQVMsSUFBVCxHQUFnQixFQUFoQjtBQUNBLElBQUcsS0FBSCxDQUFTLEtBQVQsR0FBaUIsRUFBakI7QUFDSCxLQUFJLEtBQUssS0FBTCxHQUFhLE9BQU8sS0FBckIsR0FBOEIsT0FBTyxVQUF4QyxFQUFvRDtBQUNuRCxLQUFHLEtBQUgsQ0FBUyxLQUFULEdBQWlCLElBQWpCO0FBQ0EsRUFGRCxNQUVPO0FBQ04sS0FBRyxLQUFILENBQVMsSUFBVCxHQUFnQixJQUFoQjtBQUNBO0FBQ0QsS0FBSSxLQUFLLEdBQUwsR0FBVyxPQUFPLE1BQW5CLEdBQTZCLE9BQU8sV0FBdkMsRUFBb0Q7QUFDbkQsS0FBRyxLQUFILENBQVMsTUFBVCxHQUFrQixJQUFsQjtBQUNBLEVBRkQsTUFFTztBQUNOLEtBQUcsS0FBSCxDQUFTLEdBQVQsR0FBZSxJQUFmO0FBQ0E7QUFDRDtBQUNELFNBQVMsUUFBVCxDQUFrQixDQUFsQixFQUFxQjtBQUNwQixPQUFNLEVBQUUsTUFBUjtBQUNBLEtBQUcsRUFBRSxNQUFGLENBQVMsU0FBVCxDQUFtQixRQUFuQixDQUE0QixRQUE1QixDQUFILEVBQTBDO0FBQ3pDLGFBQVcsRUFBRSxNQUFiO0FBQ0EsSUFBRSxlQUFGO0FBQ0E7QUFDRDs7QUFFRCxJQUFNLE9BQU8sU0FBUyxnQkFBVCxDQUEwQix5QkFBMUIsQ0FBYjtBQUNBLEtBQUssT0FBTCxDQUFhO0FBQUEsUUFBTyxJQUFJLGdCQUFKLENBQXFCLE9BQXJCLEVBQThCLGVBQU87QUFDeEQsTUFBSSxlQUFKO0FBQ0EsTUFBTSxLQUFLLElBQUksWUFBSixDQUFpQix1QkFBakIsQ0FBWDtBQUNBLE1BQU0sTUFBTSxTQUFTLGNBQVQsQ0FBd0IsRUFBeEIsQ0FBWjtBQUNBLE1BQUksZ0JBQUosQ0FBcUIsZUFBckIsRUFBc0MsT0FBdEMsQ0FBOEMsZUFBTztBQUNwRCxPQUFJLFNBQUosQ0FBYyxNQUFkLENBQXFCLE1BQXJCLEVBQTZCLFFBQTdCO0FBQ0EsR0FGRDtBQUdBLE1BQUksU0FBSixDQUFjLEdBQWQsQ0FBa0IsUUFBbEI7QUFDQSxNQUFHLElBQUksT0FBSixJQUFlLElBQUksT0FBdEIsRUFBK0I7QUFDeEIsT0FBSSxLQUFKLENBQVUsSUFBVixHQUFvQixJQUFJLE9BQXhCO0FBQ04sT0FBSSxLQUFKLENBQVUsR0FBVixHQUFtQixPQUFPLFdBQVAsR0FBcUIsSUFBSSxPQUE1QztBQUNBLEdBSEQsTUFHTztBQUNOLE9BQU0sUUFBTyxJQUFJLHFCQUFKLEVBQWI7QUFDQSxTQUFNLEtBQU47QUFDQSxPQUFJLEtBQUosQ0FBVSxHQUFWLEdBQW1CLE1BQUssS0FBeEI7QUFDQSxPQUFJLEtBQUosQ0FBVSxJQUFWLEdBQW9CLE1BQUssTUFBekI7QUFDQTs7QUFFRSxNQUFNLE9BQU8sSUFBSSxxQkFBSixFQUFiO0FBQ0EsTUFBRyxLQUFLLEtBQUwsR0FBYSxPQUFPLFVBQXZCLEVBQW1DO0FBQy9CLE9BQUksTUFBTSxJQUFJLEtBQUosQ0FBVSxJQUFWLENBQWUsT0FBZixDQUF1QixLQUF2QixFQUE4QixFQUE5QixDQUFWO0FBQ0EsT0FBSSxLQUFKLENBQVUsSUFBVixHQUFvQixNQUFNLEtBQUssS0FBL0I7QUFDSDtBQUNELE1BQUksS0FBSyxNQUFOLEdBQWdCLE9BQU8sV0FBMUIsRUFBdUM7QUFDbkMsT0FBSSxPQUFNLElBQUksS0FBSixDQUFVLEdBQVYsQ0FBYyxPQUFkLENBQXNCLEtBQXRCLEVBQTZCLEVBQTdCLENBQVY7QUFDQSxPQUFJLEtBQUosQ0FBVSxHQUFWLEdBQW1CLE9BQU0sS0FBSyxNQUE5QjtBQUNIO0FBQ0osUUFBTSxFQUFDLE1BQUQsRUFBSyxRQUFMLEVBQU47O0FBRUEsTUFBSSxnQkFBSjtBQUNBLFdBQVMsVUFBVCxDQUFvQixDQUFwQixFQUF1QjtBQUN0QixTQUFNLFlBQU4sRUFBb0IsRUFBRSxNQUF0Qjs7QUFFQSxLQUFFLE1BQUYsQ0FBUyxTQUFULENBQW1CLEdBQW5CLENBQXVCLFFBQXZCOztBQUVBLGdCQUFhLE9BQWI7QUFDQSxPQUFHLEVBQUUsTUFBRixDQUFTLFNBQVQsQ0FBbUIsUUFBbkIsQ0FBNEIsUUFBNUIsQ0FBSCxFQUEwQztBQUN6QyxjQUFVLFdBQVcsV0FBVyxJQUFYLENBQWdCLElBQWhCLEVBQXNCLEVBQUUsTUFBeEIsQ0FBWCxFQUE0QyxHQUE1QyxDQUFWO0FBQ0EsSUFGRCxNQUVPO0FBQ04sY0FBVSxXQUFXLGFBQWEsSUFBYixDQUFrQixJQUFsQixFQUF3QixFQUFFLE1BQTFCLENBQVgsRUFBOEMsR0FBOUMsQ0FBVjtBQUNBO0FBQ0Q7QUFDRCxXQUFTLFVBQVQsQ0FBb0IsQ0FBcEIsRUFBdUI7QUFDdEIsZ0JBQWEsT0FBYjtBQUNBLEtBQUUsTUFBRixDQUFTLFNBQVQsQ0FBbUIsTUFBbkIsQ0FBMEIsUUFBMUI7QUFDQSxTQUFNLFlBQU4sRUFBb0IsRUFBRSxNQUF0QjtBQUNBO0FBQ0QsV0FBUyxrQkFBVCxDQUE0QixDQUE1QixFQUErQjtBQUM5QixPQUFJLE9BQU8sSUFBSSxnQkFBSixDQUFxQixZQUFyQixDQUFYO0FBQ0EsT0FBRyxLQUFLLE1BQUwsR0FBYyxDQUFqQixFQUFvQjtBQUNuQixXQUFPLEtBQUssS0FBSyxNQUFMLEdBQWMsQ0FBbkIsQ0FBUDtBQUNBLElBRkQsTUFFTztBQUNOLFdBQU8sR0FBUDtBQUNBO0FBQ0QsT0FBSSxTQUFTLEtBQUssYUFBTCxDQUFtQixXQUFuQixDQUFiO0FBQ0EsU0FBTSxJQUFOO0FBQ0EsT0FBSSxhQUFKO0FBQ0EsV0FBTyxFQUFFLE9BQVQ7QUFDQyxTQUFLLEVBQUw7QUFBUztBQUNSLE9BQUUsZUFBRjtBQUNBLE9BQUUsY0FBRjtBQUNBLFNBQUcsTUFBSCxFQUFXO0FBQ1YsYUFBTyxPQUFPLHNCQUFkO0FBQ0EsYUFBTyxTQUFQLENBQWlCLE1BQWpCLENBQXdCLFFBQXhCO0FBQ0E7QUFDRCxTQUFHLENBQUMsSUFBSixFQUFVO0FBQ1QsYUFBTyxLQUFLLFFBQUwsQ0FBYyxLQUFLLFFBQUwsQ0FBYyxNQUFkLEdBQXVCLENBQXJDLENBQVA7QUFDQTtBQUNELFVBQUssU0FBTCxDQUFlLEdBQWYsQ0FBbUIsUUFBbkI7QUFDQTtBQUNELFNBQUssRUFBTDtBQUFTO0FBQ1IsT0FBRSxlQUFGO0FBQ0EsT0FBRSxjQUFGO0FBQ0EsU0FBRyxNQUFILEVBQVc7QUFDVixhQUFPLE9BQU8sa0JBQWQ7QUFDQSxhQUFPLFNBQVAsQ0FBaUIsTUFBakIsQ0FBd0IsUUFBeEI7QUFDQTtBQUNELFNBQUcsQ0FBQyxJQUFKLEVBQVU7QUFDVCxhQUFPLEtBQUssUUFBTCxDQUFjLENBQWQsQ0FBUDtBQUNBO0FBQ0QsVUFBSyxTQUFMLENBQWUsR0FBZixDQUFtQixRQUFuQjtBQUNBO0FBQ0QsU0FBSyxFQUFMO0FBQVM7QUFDUixPQUFFLGVBQUY7QUFDQSxPQUFFLGNBQUY7QUFDQSxTQUFHLE1BQUgsRUFBVztBQUNWLGFBQU8sU0FBUCxDQUFpQixNQUFqQixDQUF3QixRQUF4QjtBQUNBLGFBQU8sYUFBUCxDQUFxQixhQUFyQixDQUFtQyxTQUFuQyxDQUE2QyxNQUE3QyxDQUFvRCxNQUFwRDtBQUNBLGFBQU8sYUFBUCxDQUFxQixhQUFyQixDQUFtQyxTQUFuQyxDQUE2QyxHQUE3QyxDQUFpRCxRQUFqRDtBQUNBLE1BSkQsTUFJTztBQUNOLFVBQUcsUUFBUSxTQUFTLEdBQXBCLEVBQXlCO0FBQ3hCLG9CQUFhLEtBQUssYUFBbEI7QUFDQTtBQUNEO0FBQ0Q7QUFDRCxTQUFLLEVBQUw7QUFBUztBQUNSLE9BQUUsZUFBRjtBQUNBLE9BQUUsY0FBRjtBQUNBLFNBQUcsTUFBSCxFQUFXO0FBQ1YsaUJBQVcsTUFBWDtBQUNBLGFBQU8sYUFBUCxDQUFxQixJQUFyQixFQUEyQixTQUEzQixDQUFxQyxHQUFyQyxDQUF5QyxRQUF6QztBQUNBO0FBQ0Q7QUFDRCxTQUFLLEVBQUw7QUFBUztBQUNSLE9BQUUsZUFBRjtBQUNBLE9BQUUsY0FBRjtBQUNBLFNBQUcsTUFBSCxFQUFXO0FBQ1YsYUFBTyxLQUFQO0FBQ0E7QUFDRDtBQUNELFNBQUssRUFBTDtBQUNDO0FBQ0E7QUF2REY7QUF5REE7O0FBRUQsV0FBUyxPQUFULEdBQW1CO0FBQ2xCLE9BQUksU0FBSixDQUFjLE1BQWQsQ0FBcUIsUUFBckI7QUFDQSxZQUFTLG1CQUFULENBQTZCLFVBQTdCLEVBQXlDLGtCQUF6QztBQUNBLFlBQVMsbUJBQVQsQ0FBNkIsT0FBN0IsRUFBc0MsT0FBdEM7O0FBRUEsT0FBSSxtQkFBSixDQUF3QixPQUF4QixFQUFpQyxRQUFqQzs7QUFFQSxPQUFJLGdCQUFKLENBQXFCLElBQXJCLEVBQTJCLE9BQTNCLENBQW1DLFVBQVMsTUFBVCxFQUFpQjtBQUNuRCxXQUFPLFNBQVAsQ0FBaUIsTUFBakIsQ0FBd0IsTUFBeEIsRUFBZ0MsUUFBaEM7QUFDQSxXQUFPLG1CQUFQLENBQTJCLFlBQTNCLEVBQXlDLFVBQXpDO0FBQ0EsV0FBTyxtQkFBUCxDQUEyQixZQUEzQixFQUF5QyxVQUF6QztBQUNBLElBSkQ7QUFLQTs7QUFFRCxNQUFJLGdCQUFKLENBQXFCLElBQXJCLEVBQTJCLE9BQTNCLENBQW1DLFVBQVMsTUFBVCxFQUFpQjtBQUNuRCxVQUFPLGdCQUFQLENBQXdCLFlBQXhCLEVBQXNDLFVBQXRDO0FBQ0EsVUFBTyxnQkFBUCxDQUF3QixZQUF4QixFQUFzQyxVQUF0QztBQUNBLEdBSEQ7QUFJQSxNQUFJLGdCQUFKLENBQXFCLE9BQXJCLEVBQThCLFFBQTlCO0FBQ0EsV0FBUyxnQkFBVCxDQUEwQixTQUExQixFQUFxQyxrQkFBckM7QUFDQSxXQUFTLGdCQUFULENBQTBCLE9BQTFCLEVBQW1DLE9BQW5DO0FBQ0EsRUF6SW1CLENBQVA7QUFBQSxDQUFiIiwiZmlsZSI6ImRyb3Bkb3duLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaWYoIU5vZGVMaXN0LnByb3RvdHlwZS5mb3JFYWNoKSB7XHJcblx0Tm9kZUxpc3QucHJvdG90eXBlLmZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaDtcclxufVxyXG5cclxuY29uc3QgZGVidWcgPSAoKSA9PiB7fTsvLyBjb25zb2xlLmxvZy5iaW5kKGNvbnNvbGUpO1xyXG5mdW5jdGlvbiBjbG9zZVJlbGF0ZWQoc3VibmF2KSB7XHJcblx0c3VibmF2LnBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLm9wZW4nKS5mb3JFYWNoKGZ1bmN0aW9uKHN1Ym5hdikge1xyXG5cdFx0c3VibmF2LmNsYXNzTGlzdC5yZW1vdmUoJ29wZW4nKVxyXG5cdH0pO1xyXG59XHJcbmZ1bmN0aW9uIG9wZW5OZXN0ZWQoc3VibmF2KSB7XHJcblx0Y29uc3QgeFBvcyA9ICc5NSUnO1xyXG5cdGNvbnN0IHlQb3MgPSAnLTAuMmVtJztcclxuXHRjbG9zZVJlbGF0ZWQoc3VibmF2KTtcclxuXHRzdWJuYXYuY2xhc3NMaXN0LmFkZCgnb3BlbicpO1xyXG5cdGNvbnN0IHVsID0gc3VibmF2LnF1ZXJ5U2VsZWN0b3IoJ3VsJylcclxuXHRjb25zdCByZWN0ID0gc3VibmF2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG5cdGNvbnN0IHVsUmVjdCA9IHVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG5cclxuICAgIHVsLnN0eWxlLnRvcCA9ICcnO1xyXG4gICAgdWwuc3R5bGUuYm90dG9tID0gJyc7XHJcbiAgICB1bC5zdHlsZS5sZWZ0ID0gJyc7XHJcbiAgICB1bC5zdHlsZS5yaWdodCA9ICcnO1xyXG5cdGlmKChyZWN0LnJpZ2h0ICsgdWxSZWN0LndpZHRoKSA+IHdpbmRvdy5pbm5lcldpZHRoKSB7XHJcblx0XHR1bC5zdHlsZS5yaWdodCA9IHhQb3M7XHJcblx0fSBlbHNlIHtcclxuXHRcdHVsLnN0eWxlLmxlZnQgPSB4UG9zO1xyXG5cdH1cclxuXHRpZigocmVjdC50b3AgKyB1bFJlY3QuaGVpZ2h0KSA+IHdpbmRvdy5pbm5lckhlaWdodCkge1xyXG5cdFx0dWwuc3R5bGUuYm90dG9tID0geVBvcztcclxuXHR9IGVsc2Uge1xyXG5cdFx0dWwuc3R5bGUudG9wID0geVBvcztcclxuXHR9XHJcbn1cclxuZnVuY3Rpb24gbmF2Q2xpY2soZSkge1xyXG5cdGRlYnVnKGUudGFyZ2V0KTtcclxuXHRpZihlLnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ3N1Ym5hdicpKSB7XHJcblx0XHRvcGVuTmVzdGVkKGUudGFyZ2V0KTtcclxuXHRcdGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblx0fVxyXG59XHJcblxyXG5jb25zdCBlbHRzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtZHJvcGRvd24tdHJpZ2dlcl0nKTtcclxuZWx0cy5mb3JFYWNoKGVsdCA9PiBlbHQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBldnQgPT4ge1xyXG5cdGV2dC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHRjb25zdCBpZCA9IGVsdC5nZXRBdHRyaWJ1dGUoJ2RhdGEtZHJvcGRvd24tdHJpZ2dlcicpO1xyXG5cdGNvbnN0IG5hdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTtcclxuXHRuYXYucXVlcnlTZWxlY3RvckFsbCgnLm9wZW4sLmFjdGl2ZScpLmZvckVhY2goZWx0ID0+IHtcclxuXHRcdGVsdC5jbGFzc0xpc3QucmVtb3ZlKCdvcGVuJywgJ2FjdGl2ZScpO1xyXG5cdH0pO1xyXG5cdG5hdi5jbGFzc0xpc3QuYWRkKCdvcGVuZWQnKTtcclxuXHRpZihldnQuY2xpZW50WCAmJiBldnQuY2xpZW50WSkge1xyXG4gICAgICAgIG5hdi5zdHlsZS5sZWZ0ID0gYCR7ZXZ0LmNsaWVudFh9cHhgO1xyXG5cdFx0bmF2LnN0eWxlLnRvcCA9IGAke3dpbmRvdy5wYWdlWU9mZnNldCArIGV2dC5jbGllbnRZfXB4YDtcclxuXHR9IGVsc2Uge1xyXG5cdFx0Y29uc3QgcmVjdCA9IGVsdC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuXHRcdGRlYnVnKHJlY3QpO1xyXG5cdFx0bmF2LnN0eWxlLnRvcCA9IGAke3JlY3QucmlnaHR9cHhgO1xyXG5cdFx0bmF2LnN0eWxlLmxlZnQgPSBgJHtyZWN0LmJvdHRvbX1weGA7XHJcblx0fVxyXG5cclxuICAgIGNvbnN0IHJlY3QgPSBuYXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICBpZihyZWN0LnJpZ2h0ID4gd2luZG93LmlubmVyV2lkdGgpIHtcclxuICAgICAgICBsZXQgcHhzID0gbmF2LnN0eWxlLmxlZnQucmVwbGFjZSgvcHgkLywgJycpO1xyXG4gICAgICAgIG5hdi5zdHlsZS5sZWZ0ID0gYCR7cHhzIC0gcmVjdC53aWR0aH1weGA7XHJcbiAgICB9XHJcbiAgICBpZigocmVjdC5ib3R0b20pID4gd2luZG93LmlubmVySGVpZ2h0KSB7XHJcbiAgICAgICAgbGV0IHB4cyA9IG5hdi5zdHlsZS50b3AucmVwbGFjZSgvcHgkLywgJycpO1xyXG4gICAgICAgIG5hdi5zdHlsZS50b3AgPSBgJHtweHMgLSByZWN0LmhlaWdodH1weGA7XHJcbiAgICB9XHJcblx0ZGVidWcoe2lkLCBuYXZ9KTtcclxuXHJcblx0bGV0IHRpbWVvdXQ7XHJcblx0ZnVuY3Rpb24gbW91c2VFbnRlcihlKSB7XHJcblx0XHRkZWJ1ZygnbW91c2VlbnRlcicsIGUudGFyZ2V0KTtcclxuXHJcblx0XHRlLnRhcmdldC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTtcclxuXHJcblx0XHRjbGVhclRpbWVvdXQodGltZW91dCk7XHJcblx0XHRpZihlLnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ3N1Ym5hdicpKSB7XHJcblx0XHRcdHRpbWVvdXQgPSBzZXRUaW1lb3V0KG9wZW5OZXN0ZWQuYmluZChudWxsLCBlLnRhcmdldCksIDUwMCk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHR0aW1lb3V0ID0gc2V0VGltZW91dChjbG9zZVJlbGF0ZWQuYmluZChudWxsLCBlLnRhcmdldCksIDUwMCk7XHJcblx0XHR9XHJcblx0fVxyXG5cdGZ1bmN0aW9uIG1vdXNlTGVhdmUoZSkge1xyXG5cdFx0Y2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xyXG5cdFx0ZS50YXJnZXQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7XHJcblx0XHRkZWJ1ZygnbW91c2VsZWF2ZScsIGUudGFyZ2V0KTtcclxuXHR9XHJcblx0ZnVuY3Rpb24ga2V5Ym9hcmROYXZpZ2F0aW9uKGUpIHtcclxuXHRcdGxldCBvcGVuID0gbmF2LnF1ZXJ5U2VsZWN0b3JBbGwoJy5vcGVuID4gdWwnKTtcclxuXHRcdGlmKG9wZW4ubGVuZ3RoID4gMCkge1xyXG5cdFx0XHRvcGVuID0gb3BlbltvcGVuLmxlbmd0aCAtIDFdO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0b3BlbiA9IG5hdjtcclxuXHRcdH1cclxuXHRcdGxldCBhY3RpdmUgPSBvcGVuLnF1ZXJ5U2VsZWN0b3IoJ2xpLmFjdGl2ZScpO1xyXG5cdFx0ZGVidWcob3Blbik7XHJcblx0XHRsZXQgbmV4dDtcclxuXHRcdHN3aXRjaChlLmtleUNvZGUpIHtcclxuXHRcdFx0Y2FzZSAzODogLy8gdXAgYXJyb3dcclxuXHRcdFx0XHRlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcclxuXHRcdFx0XHRpZihhY3RpdmUpIHtcclxuXHRcdFx0XHRcdG5leHQgPSBhY3RpdmUucHJldmlvdXNFbGVtZW50U2libGluZztcclxuXHRcdFx0XHRcdGFjdGl2ZS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0aWYoIW5leHQpIHtcclxuXHRcdFx0XHRcdG5leHQgPSBvcGVuLmNoaWxkcmVuW29wZW4uY2hpbGRyZW4ubGVuZ3RoIC0gMV07XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdG5leHQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgNDA6IC8vIGRvd24gYXJyb3dcclxuXHRcdFx0XHRlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcclxuXHRcdFx0XHRpZihhY3RpdmUpIHtcclxuXHRcdFx0XHRcdG5leHQgPSBhY3RpdmUubmV4dEVsZW1lbnRTaWJsaW5nO1xyXG5cdFx0XHRcdFx0YWN0aXZlLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRpZighbmV4dCkge1xyXG5cdFx0XHRcdFx0bmV4dCA9IG9wZW4uY2hpbGRyZW5bMF07XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdG5leHQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgMzc6IC8vIGxlZnQgYXJyb3dcclxuXHRcdFx0XHRlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcclxuXHRcdFx0XHRpZihhY3RpdmUpIHtcclxuXHRcdFx0XHRcdGFjdGl2ZS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTtcclxuXHRcdFx0XHRcdGFjdGl2ZS5wYXJlbnRFbGVtZW50LnBhcmVudEVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbicpO1xyXG5cdFx0XHRcdFx0YWN0aXZlLnBhcmVudEVsZW1lbnQucGFyZW50RWxlbWVudC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTtcclxuXHRcdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdFx0aWYob3BlbiAmJiBvcGVuICE9PSBuYXYpIHtcclxuXHRcdFx0XHRcdFx0Y2xvc2VSZWxhdGVkKG9wZW4ucGFyZW50RWxlbWVudCk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHRjYXNlIDM5OiAvLyByaWdodCBhcnJvd1xyXG5cdFx0XHRcdGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblx0XHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGlmKGFjdGl2ZSkge1xyXG5cdFx0XHRcdFx0b3Blbk5lc3RlZChhY3RpdmUpO1xyXG5cdFx0XHRcdFx0YWN0aXZlLnF1ZXJ5U2VsZWN0b3IoJ2xpJykuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHRjYXNlIDEzOiAvLyBlbnRlclxyXG5cdFx0XHRcdGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblx0XHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGlmKGFjdGl2ZSkge1xyXG5cdFx0XHRcdFx0YWN0aXZlLmNsaWNrKCk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHRjYXNlIDI3OlxyXG5cdFx0XHRcdGRpc21pc3MoKTtcclxuXHRcdFx0XHRicmVhaztcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGZ1bmN0aW9uIGRpc21pc3MoKSB7XHJcblx0XHRuYXYuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbmVkJyk7XHJcblx0XHRkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlwcmVzcycsIGtleWJvYXJkTmF2aWdhdGlvbik7XHJcblx0XHRkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIGRpc21pc3MpO1xyXG5cclxuXHRcdG5hdi5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIG5hdkNsaWNrKTtcclxuXHJcblx0XHRuYXYucXVlcnlTZWxlY3RvckFsbCgnbGknKS5mb3JFYWNoKGZ1bmN0aW9uKHN1Ym5hdikge1xyXG5cdFx0XHRzdWJuYXYuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbicsICdhY3RpdmUnKTtcclxuXHRcdFx0c3VibmF2LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZW50ZXInLCBtb3VzZUVudGVyKTtcclxuXHRcdFx0c3VibmF2LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBtb3VzZUxlYXZlKTtcclxuXHRcdH0pO1xyXG5cdH1cclxuXHJcblx0bmF2LnF1ZXJ5U2VsZWN0b3JBbGwoJ2xpJykuZm9yRWFjaChmdW5jdGlvbihzdWJuYXYpIHtcclxuXHRcdHN1Ym5hdi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgbW91c2VFbnRlcik7XHJcblx0XHRzdWJuYXYuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIG1vdXNlTGVhdmUpO1xyXG5cdH0pO1xyXG5cdG5hdi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIG5hdkNsaWNrKTtcclxuXHRkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5Ym9hcmROYXZpZ2F0aW9uKTtcclxuXHRkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGRpc21pc3MpO1xyXG59KSk7XHJcbiJdfQ==