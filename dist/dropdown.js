'use strict';

if (!NodeList.prototype.forEach) {
	NodeList.prototype.forEach = Array.prototype.forEach;
}

var debug = function debug() {}; // console.log.bind(console);
function closeRelated(subnav) {
	subnav.parentElement.querySelectorAll('.open').forEach(function (subnav) {
		subnav.classList.remove('open');
	});
}
function openNested(subnav) {
	var xPos = '95%';
	var yPos = '-0.2em';
	closeRelated(subnav);
	subnav.classList.add('open');
	var ul = subnav.querySelector('ul');
	var rect = subnav.getBoundingClientRect();
	var ulRect = ul.getBoundingClientRect();
	if (rect.top + ulRect.height > window.innerHeight) {
		ul.style.top = '';
		ul.style.bottom = yPos;
	} else {
		ul.style.top = yPos;
		ul.style.bottom = '';
	}
	if (rect.right + ulRect.width > window.innerWidth) {
		ul.style.left = '';
		ul.style.right = xPos;
	} else {
		ul.style.left = xPos;
		ul.style.right = '';
	}
}
function navClick(e) {
	debug(e.target);
	if (e.target.classList.contains('subnav')) {
		openNested(e.target);
		e.stopPropagation();
	}
}

var elts = document.querySelectorAll('[data-dropdown-trigger]');
elts.forEach(function (elt) {
	return elt.addEventListener('click', function (evt) {
		evt.stopPropagation();
		var id = elt.getAttribute('data-dropdown-trigger');
		var nav = document.getElementById(id);
		nav.querySelectorAll('.open,.active').forEach(function (elt) {
			elt.classList.remove('open', 'active');
		});
		nav.classList.add('opened');
		if (evt.clientX && evt.clientY) {
			var rect = nav.getBoundingClientRect();
			if (rect.width + evt.clientX > window.innerWidth) {
				nav.style.left = '';
				nav.style.right = window.innerWidth - evt.clientX + 'px';
			} else {
				nav.style.left = evt.clientX + 'px';
				nav.style.right = '';
			}
			nav.style.top = window.pageYOffset + evt.clientY + 'px';
			nav.style.bottom = '';
			console.log(rect.height + evt.clientY, window.innerHeight);
			nav.style.transform = '';
			if (rect.height + evt.clientY > window.innerHeight) {
				nav.style.transform = 'translateY(-100%)';
			}
		} else {
			var _rect = elt.getBoundingClientRect();
			debug(_rect);
			nav.style.top = _rect.right + 'px';
			nav.style.left = _rect.bottom + 'px';
		}
		debug({ id: id, nav: nav });

		var timeout = void 0;
		function mouseEnter(e) {
			debug('mouseenter', e.target);

			e.target.classList.add('active');

			clearTimeout(timeout);
			if (e.target.classList.contains('subnav')) {
				timeout = setTimeout(openNested.bind(null, e.target), 500);
			} else {
				timeout = setTimeout(closeRelated.bind(null, e.target), 500);
			}
		}
		function mouseLeave(e) {
			clearTimeout(timeout);
			e.target.classList.remove('active');
			debug('mouseleave', e.target);
		}
		function keyboardNavigation(e) {
			var open = nav.querySelectorAll('.open > ul');
			if (open.length > 0) {
				open = open[open.length - 1];
			} else {
				open = nav;
			}
			var active = open.querySelector('li.active');
			debug(open);
			var next = void 0;
			switch (e.keyCode) {
				case 38:
					// up arrow
					e.stopPropagation();
					e.preventDefault();
					if (active) {
						next = active.previousElementSibling;
						active.classList.remove('active');
					}
					if (!next) {
						next = open.children[open.children.length - 1];
					}
					next.classList.add('active');
					break;
				case 40:
					// down arrow
					e.stopPropagation();
					e.preventDefault();
					if (active) {
						next = active.nextElementSibling;
						active.classList.remove('active');
					}
					if (!next) {
						next = open.children[0];
					}
					next.classList.add('active');
					break;
				case 37:
					// left arrow
					e.stopPropagation();
					e.preventDefault();
					if (active) {
						active.classList.remove('active');
						active.parentElement.parentElement.classList.remove('open');
						active.parentElement.parentElement.classList.add('active');
					} else {
						if (open && open !== nav) {
							closeRelated(open.parentElement);
						}
					}
					break;
				case 39:
					// right arrow
					e.stopPropagation();
					e.preventDefault();
					if (active) {
						openNested(active);
						active.querySelector('li').classList.add('active');
					}
					break;
				case 13:
					// enter
					e.stopPropagation();
					e.preventDefault();
					if (active) {
						active.click();
					}
					break;
				case 27:
					dismiss();
					break;
			}
		}

		function dismiss() {
			nav.classList.remove('opened');
			document.removeEventListener('keypress', keyboardNavigation);
			document.removeEventListener('click', dismiss);

			nav.removeEventListener('click', navClick);

			nav.querySelectorAll('li').forEach(function (subnav) {
				subnav.classList.remove('open', 'active');
				subnav.removeEventListener('mouseenter', mouseEnter);
				subnav.removeEventListener('mouseleave', mouseLeave);
			});
		}

		nav.querySelectorAll('li').forEach(function (subnav) {
			subnav.addEventListener('mouseenter', mouseEnter);
			subnav.addEventListener('mouseleave', mouseLeave);
		});
		nav.addEventListener('click', navClick);
		document.addEventListener('keydown', keyboardNavigation);
		document.addEventListener('click', dismiss);
	});
});

//# sourceMappingURL=data:application/json;base64,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LG1CQUFKLENBQXdCLE9BQXhCLEVBQWlDLFFBQWpDOztBQUVBLE9BQUksZ0JBQUosQ0FBcUIsSUFBckIsRUFBMkIsT0FBM0IsQ0FBbUMsVUFBUyxNQUFULEVBQWlCO0FBQ25ELFdBQU8sU0FBUCxDQUFpQixNQUFqQixDQUF3QixNQUF4QixFQUFnQyxRQUFoQztBQUNBLFdBQU8sbUJBQVAsQ0FBMkIsWUFBM0IsRUFBeUMsVUFBekM7QUFDQSxXQUFPLG1CQUFQLENBQTJCLFlBQTNCLEVBQXlDLFVBQXpDO0FBQ0EsSUFKRDtBQUtBOztBQUVELE1BQUksZ0JBQUosQ0FBcUIsSUFBckIsRUFBMkIsT0FBM0IsQ0FBbUMsVUFBUyxNQUFULEVBQWlCO0FBQ25ELFVBQU8sZ0JBQVAsQ0FBd0IsWUFBeEIsRUFBc0MsVUFBdEM7QUFDQSxVQUFPLGdCQUFQLENBQXdCLFlBQXhCLEVBQXNDLFVBQXRDO0FBQ0EsR0FIRDtBQUlBLE1BQUksZ0JBQUosQ0FBcUIsT0FBckIsRUFBOEIsUUFBOUI7QUFDQSxXQUFTLGdCQUFULENBQTBCLFNBQTFCLEVBQXFDLGtCQUFyQztBQUNBLFdBQVMsZ0JBQVQsQ0FBMEIsT0FBMUIsRUFBbUMsT0FBbkM7QUFDQSxFQTVJbUIsQ0FBUDtBQUFBLENBQWIiLCJmaWxlIjoiZHJvcGRvd24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpZighTm9kZUxpc3QucHJvdG90eXBlLmZvckVhY2gpIHtcclxuXHROb2RlTGlzdC5wcm90b3R5cGUuZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoO1xyXG59XHJcblxyXG5jb25zdCBkZWJ1ZyA9ICgpID0+IHt9Oy8vIGNvbnNvbGUubG9nLmJpbmQoY29uc29sZSk7XHJcbmZ1bmN0aW9uIGNsb3NlUmVsYXRlZChzdWJuYXYpIHtcclxuXHRzdWJuYXYucGFyZW50RWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcub3BlbicpLmZvckVhY2goZnVuY3Rpb24oc3VibmF2KSB7XHJcblx0XHRzdWJuYXYuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbicpXHJcblx0fSk7XHJcbn1cclxuZnVuY3Rpb24gb3Blbk5lc3RlZChzdWJuYXYpIHtcclxuXHRjb25zdCB4UG9zID0gJzk1JSc7XHJcblx0Y29uc3QgeVBvcyA9ICctMC4yZW0nO1xyXG5cdGNsb3NlUmVsYXRlZChzdWJuYXYpO1xyXG5cdHN1Ym5hdi5jbGFzc0xpc3QuYWRkKCdvcGVuJyk7XHJcblx0Y29uc3QgdWwgPSBzdWJuYXYucXVlcnlTZWxlY3RvcigndWwnKVxyXG5cdGNvbnN0IHJlY3QgPSBzdWJuYXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcblx0Y29uc3QgdWxSZWN0ID0gdWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcblx0aWYoKHJlY3QudG9wICsgdWxSZWN0LmhlaWdodCkgPiB3aW5kb3cuaW5uZXJIZWlnaHQpIHtcclxuXHRcdHVsLnN0eWxlLnRvcCA9ICcnO1xyXG5cdFx0dWwuc3R5bGUuYm90dG9tID0geVBvcztcclxuXHR9IGVsc2Uge1xyXG5cdFx0dWwuc3R5bGUudG9wID0geVBvcztcclxuXHRcdHVsLnN0eWxlLmJvdHRvbSA9ICcnO1xyXG5cdH1cclxuXHRpZigocmVjdC5yaWdodCArIHVsUmVjdC53aWR0aCkgPiB3aW5kb3cuaW5uZXJXaWR0aCkge1xyXG5cdFx0dWwuc3R5bGUubGVmdCA9ICcnO1xyXG5cdFx0dWwuc3R5bGUucmlnaHQgPSB4UG9zO1xyXG5cdH0gZWxzZSB7XHJcblx0XHR1bC5zdHlsZS5sZWZ0ID0geFBvcztcclxuXHRcdHVsLnN0eWxlLnJpZ2h0ID0gJyc7XHJcblx0fVxyXG59XHJcbmZ1bmN0aW9uIG5hdkNsaWNrKGUpIHtcclxuXHRkZWJ1ZyhlLnRhcmdldCk7XHJcblx0aWYoZS50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCdzdWJuYXYnKSkge1xyXG5cdFx0b3Blbk5lc3RlZChlLnRhcmdldCk7XHJcblx0XHRlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cdH1cclxufVxyXG5cclxuY29uc3QgZWx0cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLWRyb3Bkb3duLXRyaWdnZXJdJyk7XHJcbmVsdHMuZm9yRWFjaChlbHQgPT4gZWx0LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZXZ0ID0+IHtcclxuXHRldnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblx0Y29uc3QgaWQgPSBlbHQuZ2V0QXR0cmlidXRlKCdkYXRhLWRyb3Bkb3duLXRyaWdnZXInKTtcclxuXHRjb25zdCBuYXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7XHJcblx0bmF2LnF1ZXJ5U2VsZWN0b3JBbGwoJy5vcGVuLC5hY3RpdmUnKS5mb3JFYWNoKGVsdCA9PiB7XHJcblx0XHRlbHQuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbicsICdhY3RpdmUnKTtcclxuXHR9KTtcclxuXHRuYXYuY2xhc3NMaXN0LmFkZCgnb3BlbmVkJyk7XHJcblx0aWYoZXZ0LmNsaWVudFggJiYgZXZ0LmNsaWVudFkpIHtcclxuXHRcdGNvbnN0IHJlY3QgPSBuYXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcblx0XHRpZigocmVjdC53aWR0aCArIGV2dC5jbGllbnRYKSA+IHdpbmRvdy5pbm5lcldpZHRoKSB7XHJcblx0XHRcdG5hdi5zdHlsZS5sZWZ0ID0gJyc7XHJcblx0XHRcdG5hdi5zdHlsZS5yaWdodCA9IGAke3dpbmRvdy5pbm5lcldpZHRoIC0gZXZ0LmNsaWVudFh9cHhgO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0bmF2LnN0eWxlLmxlZnQgPSBgJHtldnQuY2xpZW50WH1weGA7XHJcblx0XHRcdG5hdi5zdHlsZS5yaWdodCA9ICcnO1xyXG5cdFx0fVxyXG5cdFx0bmF2LnN0eWxlLnRvcCA9IGAke3dpbmRvdy5wYWdlWU9mZnNldCArIGV2dC5jbGllbnRZfXB4YDtcclxuXHRcdG5hdi5zdHlsZS5ib3R0b20gPSAnJztcclxuXHRcdGNvbnNvbGUubG9nKHJlY3QuaGVpZ2h0ICsgZXZ0LmNsaWVudFksIHdpbmRvdy5pbm5lckhlaWdodCk7XHJcblx0XHRuYXYuc3R5bGUudHJhbnNmb3JtID0gJyc7XHJcblx0XHRpZigocmVjdC5oZWlnaHQgKyBldnQuY2xpZW50WSkgPiB3aW5kb3cuaW5uZXJIZWlnaHQpIHtcclxuXHRcdFx0bmF2LnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGVZKC0xMDAlKSc7XHJcblx0XHR9XHJcblx0fSBlbHNlIHtcclxuXHRcdGNvbnN0IHJlY3QgPSBlbHQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcblx0XHRkZWJ1ZyhyZWN0KTtcclxuXHRcdG5hdi5zdHlsZS50b3AgPSBgJHtyZWN0LnJpZ2h0fXB4YDtcclxuXHRcdG5hdi5zdHlsZS5sZWZ0ID0gYCR7cmVjdC5ib3R0b219cHhgO1xyXG5cdH1cclxuXHRkZWJ1Zyh7aWQsIG5hdn0pO1xyXG5cclxuXHRsZXQgdGltZW91dDtcclxuXHRmdW5jdGlvbiBtb3VzZUVudGVyKGUpIHtcclxuXHRcdGRlYnVnKCdtb3VzZWVudGVyJywgZS50YXJnZXQpO1xyXG5cclxuXHRcdGUudGFyZ2V0LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpO1xyXG5cclxuXHRcdGNsZWFyVGltZW91dCh0aW1lb3V0KTtcclxuXHRcdGlmKGUudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygnc3VibmF2JykpIHtcclxuXHRcdFx0dGltZW91dCA9IHNldFRpbWVvdXQob3Blbk5lc3RlZC5iaW5kKG51bGwsIGUudGFyZ2V0KSwgNTAwKTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHRpbWVvdXQgPSBzZXRUaW1lb3V0KGNsb3NlUmVsYXRlZC5iaW5kKG51bGwsIGUudGFyZ2V0KSwgNTAwKTtcclxuXHRcdH1cclxuXHR9XHJcblx0ZnVuY3Rpb24gbW91c2VMZWF2ZShlKSB7XHJcblx0XHRjbGVhclRpbWVvdXQodGltZW91dCk7XHJcblx0XHRlLnRhcmdldC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTtcclxuXHRcdGRlYnVnKCdtb3VzZWxlYXZlJywgZS50YXJnZXQpO1xyXG5cdH1cclxuXHRmdW5jdGlvbiBrZXlib2FyZE5hdmlnYXRpb24oZSkge1xyXG5cdFx0bGV0IG9wZW4gPSBuYXYucXVlcnlTZWxlY3RvckFsbCgnLm9wZW4gPiB1bCcpO1xyXG5cdFx0aWYob3Blbi5sZW5ndGggPiAwKSB7XHJcblx0XHRcdG9wZW4gPSBvcGVuW29wZW4ubGVuZ3RoIC0gMV07XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRvcGVuID0gbmF2O1xyXG5cdFx0fVxyXG5cdFx0bGV0IGFjdGl2ZSA9IG9wZW4ucXVlcnlTZWxlY3RvcignbGkuYWN0aXZlJyk7XHJcblx0XHRkZWJ1ZyhvcGVuKTtcclxuXHRcdGxldCBuZXh0O1xyXG5cdFx0c3dpdGNoKGUua2V5Q29kZSkge1xyXG5cdFx0XHRjYXNlIDM4OiAvLyB1cCBhcnJvd1xyXG5cdFx0XHRcdGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblx0XHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGlmKGFjdGl2ZSkge1xyXG5cdFx0XHRcdFx0bmV4dCA9IGFjdGl2ZS5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xyXG5cdFx0XHRcdFx0YWN0aXZlLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRpZighbmV4dCkge1xyXG5cdFx0XHRcdFx0bmV4dCA9IG9wZW4uY2hpbGRyZW5bb3Blbi5jaGlsZHJlbi5sZW5ndGggLSAxXTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0bmV4dC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTtcclxuXHRcdFx0XHRicmVhaztcclxuXHRcdFx0Y2FzZSA0MDogLy8gZG93biBhcnJvd1xyXG5cdFx0XHRcdGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblx0XHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGlmKGFjdGl2ZSkge1xyXG5cdFx0XHRcdFx0bmV4dCA9IGFjdGl2ZS5uZXh0RWxlbWVudFNpYmxpbmc7XHJcblx0XHRcdFx0XHRhY3RpdmUuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdGlmKCFuZXh0KSB7XHJcblx0XHRcdFx0XHRuZXh0ID0gb3Blbi5jaGlsZHJlblswXTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0bmV4dC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTtcclxuXHRcdFx0XHRicmVhaztcclxuXHRcdFx0Y2FzZSAzNzogLy8gbGVmdCBhcnJvd1xyXG5cdFx0XHRcdGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblx0XHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGlmKGFjdGl2ZSkge1xyXG5cdFx0XHRcdFx0YWN0aXZlLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpO1xyXG5cdFx0XHRcdFx0YWN0aXZlLnBhcmVudEVsZW1lbnQucGFyZW50RWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCdvcGVuJyk7XHJcblx0XHRcdFx0XHRhY3RpdmUucGFyZW50RWxlbWVudC5wYXJlbnRFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpO1xyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRpZihvcGVuICYmIG9wZW4gIT09IG5hdikge1xyXG5cdFx0XHRcdFx0XHRjbG9zZVJlbGF0ZWQob3Blbi5wYXJlbnRFbGVtZW50KTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgMzk6IC8vIHJpZ2h0IGFycm93XHJcblx0XHRcdFx0ZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHRcdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XHJcblx0XHRcdFx0aWYoYWN0aXZlKSB7XHJcblx0XHRcdFx0XHRvcGVuTmVzdGVkKGFjdGl2ZSk7XHJcblx0XHRcdFx0XHRhY3RpdmUucXVlcnlTZWxlY3RvcignbGknKS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgMTM6IC8vIGVudGVyXHJcblx0XHRcdFx0ZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHRcdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XHJcblx0XHRcdFx0aWYoYWN0aXZlKSB7XHJcblx0XHRcdFx0XHRhY3RpdmUuY2xpY2soKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgMjc6XHJcblx0XHRcdFx0ZGlzbWlzcygpO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gZGlzbWlzcygpIHtcclxuXHRcdG5hdi5jbGFzc0xpc3QucmVtb3ZlKCdvcGVuZWQnKTtcclxuXHRcdGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleXByZXNzJywga2V5Ym9hcmROYXZpZ2F0aW9uKTtcclxuXHRcdGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZGlzbWlzcyk7XHJcblxyXG5cdFx0bmF2LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgbmF2Q2xpY2spO1xyXG5cclxuXHRcdG5hdi5xdWVyeVNlbGVjdG9yQWxsKCdsaScpLmZvckVhY2goZnVuY3Rpb24oc3VibmF2KSB7XHJcblx0XHRcdHN1Ym5hdi5jbGFzc0xpc3QucmVtb3ZlKCdvcGVuJywgJ2FjdGl2ZScpO1xyXG5cdFx0XHRzdWJuYXYucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2VlbnRlcicsIG1vdXNlRW50ZXIpO1xyXG5cdFx0XHRzdWJuYXYucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIG1vdXNlTGVhdmUpO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRuYXYucXVlcnlTZWxlY3RvckFsbCgnbGknKS5mb3JFYWNoKGZ1bmN0aW9uKHN1Ym5hdikge1xyXG5cdFx0c3VibmF2LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZW50ZXInLCBtb3VzZUVudGVyKTtcclxuXHRcdHN1Ym5hdi5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgbW91c2VMZWF2ZSk7XHJcblx0fSk7XHJcblx0bmF2LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgbmF2Q2xpY2spO1xyXG5cdGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBrZXlib2FyZE5hdmlnYXRpb24pO1xyXG5cdGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZGlzbWlzcyk7XHJcbn0pKTtcclxuIl19